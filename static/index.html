<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Shorts Generator</title>
    <link rel="stylesheet" href="styles.css">

</head>
<body>
    <h1>Video Shorts Generator</h1>
    <form id="uploadForm" enctype="multipart/form-data">
        <label for="video">Upload Video:</label>
        <input type="file" id="video" name="video" accept="video/*,.mkv" required>
        <button type="submit">Upload</button>
    </form>
    <div id="status"></div>
    <h2>Videos</h2>
    <table id="videosTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Complete Video</th>
                <th>Shorts</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Replace the existing modal divs with these updated versions -->
    <div id="shortsModal" class="modal">
        <div id="shortsModalContent">
            <button class="close-button" onclick="closeShortsModal()">&times;</button>
            <h3>Shorts</h3>
            <div id="shortsList"></div>
        </div>
    </div>

    <div id="videoModal" class="modal">
        <div id="videoModalContent">
            <button class="close-button" onclick="closeVideoModal()">&times;</button>
            <video id="modalVideo" controls></video>
        </div>
    </div>

    <script>
        let videosShorts = {};

        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('video', document.getElementById('video').files[0]);
            document.getElementById('status').textContent = 'Uploading...';
            fetch('/upload', { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('status').textContent = `Processing video ${data.video_id}...`;
                    setTimeout(loadVideos, 2000); // Poll after delay
                })
                .catch(error => {
                    document.getElementById('status').textContent = 'Upload failed.';
                    console.error(error);
                });
        });

        function loadVideos() {
        fetch('/videos')
            .then(response => response.json())
            .then(videos => {
                const tbody = document.querySelector('#videosTable tbody');
                tbody.innerHTML = '';
                videos.forEach(video => {
                    videosShorts[video.id] = video.shorts;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${video.id}</td>
                        <td>${video.title}</td>
                        <td><button onclick="playVideo('${video.edited_video_url}')">Play</button></td>
                        <td><button onclick="showShorts(${video.id})">View Shorts</button></td>
                        <td>
                            <button onclick="deleteVideo(${video.id})">Delete</button>
                            <button onclick="refreshShorts(${video.id})">Refresh</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                document.getElementById('status').textContent = '';
            })
            .catch(error => console.error('Error loading videos:', error));
        }

        // Add the refreshShorts function
        function refreshShorts(videoId) {
            if (confirm('Refresh shorts for this video? This will replace all uncreated shorts with new ones.')) {
                fetch(`/videos/${videoId}/refresh`, { method: 'POST' })
                    .then(response => {
                        if (response.ok) {
                            document.getElementById('status').textContent = 'Refreshing shorts...';
                            setTimeout(loadVideos, 2000); // Refresh table after delay
                        } else {
                            alert('Failed to refresh shorts.');
                        }
                    })
                    .catch(error => console.error('Error refreshing shorts:', error));
            }
        }

        function showShorts(videoId) {
            const shorts = videosShorts[videoId];
            const shortsList = document.getElementById('shortsList');
            shortsList.innerHTML = shorts.map(short => `
                <div>
                    <p>${short.short_name}: ${short.short_description}</p>
                    <label>Start Time: <input type="text" value="${short.start_time}" id="start-${short.id}"></label>
                    <label>End Time: <input type="text" value="${short.end_time}" id="end-${short.id}"></label>
                    <button onclick="updateShort(${videoId}, ${short.id})">Update</button>
                    <button onclick="createShort(${videoId}, ${short.id})" ${short.status !== 'pending' ? 'disabled' : ''}>Create</button>
                    <button onclick="recreateShort(${videoId}, ${short.id})" ${short.status !== 'completed' ? 'disabled' : ''}>Recreate</button>
                    <button onclick="playVideo('${short.short_url}')" ${short.status !== 'completed' ? 'disabled' : ''}>Play</button>
                </div>
            `).join('');
            document.getElementById('shortsModal').style.display = 'block';
        }
        function recreateShort(videoId, shortId) {
            if (confirm('Are you sure you want to recreate this short? This will overwrite the existing file.')) {
                fetch(`/videos/${videoId}/shorts/${shortId}/recreate`, { method: 'POST' })
                    .then(response => {
                        if (response.ok) {
                            alert('Short recreation started.');
                            setTimeout(loadVideos, 2000);  // Refresh after delay
                        } else {
                            alert('Failed to recreate short.');
                        }
                    })
                    .catch(error => console.error('Error recreating short:', error));
            }
        }
        function updateShort(videoId, shortId) {
            const startTime = document.getElementById(`start-${shortId}`).value;
            const endTime = document.getElementById(`end-${shortId}`).value;
            fetch(`/videos/${videoId}/shorts/${shortId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ start_time: startTime, end_time: endTime })
            })
            .then(response => {
                if (response.ok) {
                    alert('Short updated successfully.');
                    loadVideos();  // Refresh the video list
                } else {
                    alert('Failed to update short.');
                }
            })
            .catch(error => console.error('Error updating short:', error));
        }

        function createShort(videoId, shortId) {
            fetch(`/videos/${videoId}/shorts/${shortId}/create`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert('Short creation started.');
                        setTimeout(loadVideos, 2000); // Refresh after delay
                    } else {
                        alert('Failed to create short.');
                    }
                })
                .catch(error => console.error('Error creating short:', error));
        }

        function playVideo(url) {
            if (url) {
                document.getElementById('modalVideo').src = url;
                document.getElementById('videoModal').style.display = 'block';
            }
        }

        function closeShortsModal() {
            document.getElementById('shortsModal').style.display = 'none';
        }

        function closeVideoModal() {
            const video = document.getElementById('modalVideo');
            video.pause();
            video.src = '';
            document.getElementById('videoModal').style.display = 'none';
        }

        function deleteVideo(videoId) {
            if (confirm('Delete this video and its shorts?')) {
                fetch(`/videos/${videoId}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) loadVideos();
                        else alert('Failed to delete video.');
                    })
                    .catch(error => console.error('Error deleting video:', error));
            }
        }

        document.addEventListener('DOMContentLoaded', loadVideos);
    </script>
</body>
</html>